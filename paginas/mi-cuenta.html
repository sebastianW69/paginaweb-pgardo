<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mi cuenta - TextilBog</title>
  <link rel="stylesheet" href="../css/estilo.css" />
  <link rel="stylesheet" href="../bootstrap-5.3.3-dist/bootstrap-5.3.3-dist/css/bootstrap.min.css" />
  <style>
    /* Estilos r√°pidos para el panel */
    .dashboard { display: flex; gap: 1rem; min-height: 70vh; }
    .sidebar { width: 220px; background:#fff; border-right:1px solid #e6e6e6; padding:1rem; }
    .sidebar .item { padding:0.6rem 0.4rem; cursor:pointer; border-radius:6px; }
    .sidebar .item:hover, .sidebar .item.active { background: #f2f6ff; }
    .content { flex:1; padding:1rem; background:#fafafa; }
    .card { background:#fff; padding:1rem; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.04); margin-bottom:1rem; }
    .product-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:1rem; }
    .product-card img { width:100%; height:140px; object-fit:cover; border-radius:6px; }
  </style>
</head>
<body data-theme="light">
  <header class="bg-light shadow-sm">
    <div class="container-fluid d-flex align-items-center py-2 flex-wrap">
      <div class="logo flex-grow-1">TextilBog</div>
      <nav class="navlinks d-none d-md-flex gap-3">
        <a href="../index.html" class="nav-link">Inicio</a>
        <a href="categoria.html" class="nav-link">Categor√≠as</a>
        <a href="vender.html" class="nav-link">Vender</a>
        <a href="iniciar-sesion.html" class="nav-link" id="linkLogin">Iniciar sesi√≥n</a>
        <a href="mi-cuenta.html" class="nav-link d-none" id="linkCuenta">Mi cuenta</a>
      </nav>
      <button class="btn btn-outline-secondary d-md-none ms-auto" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuMobile">‚ò∞</button>
    </div>
  </header>

  <main class="container py-4">
    <div class="dashboard">
      <aside class="sidebar card">
        <div id="perfilResumen" class="mb-3"></div>
        <div class="item active" data-view="dashboardView">üìà Estad√≠sticas</div>
        <div class="item" data-view="productosView">üßæ Mis productos</div>
        <div class="item" data-view="subirView">‚¨ÜÔ∏è Subir producto</div>
        <div class="item" data-view="planView">üíé Mi plan</div>
        <div class="item" id="cerrarSesionBtn">üö™ Cerrar sesi√≥n</div>
      </aside>

      <section class="content">
        <!-- Dashboard / Estad√≠sticas -->
        <div id="dashboardView" class="view">
          <div class="card">
            <h5>Ventas √∫ltimos 7 d√≠as</h5>
            <canvas id="ventasChart" width="400" height="160"></canvas>
          </div>
          <div class="card">
            <h6>Resumen r√°pido</h6>
            <div class="row">
              <div class="col-6">
                <strong id="totalVendido">$0.00</strong><br><small>Total vendido</small>
              </div>
              <div class="col-6">
                <strong id="productosActivos">0</strong><br><small>Productos activos</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Mis productos -->
        <div id="productosView" class="view" style="display:none;">
          <div class="card">
            <h5>Mis productos</h5>
            <div id="listaProductos" class="product-grid"></div>
          </div>
        </div>

        <!-- Subir producto -->
        <div id="subirView" class="view" style="display:none;">
          <div class="card">
            <h5>Subir producto</h5>
            <form id="formSubir">
              <div class="mb-3">
                <label class="form-label">Nombre</label>
                <input id="p_nombre" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Precio</label>
                <input id="p_precio" type="number" step="0.01" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Stock</label>
                <input id="p_stock" type="number" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Descripci√≥n</label>
                <textarea id="p_descripcion" class="form-control" rows="3"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Imagen</label>
                <input id="p_imagen" type="file" accept="image/*" class="form-control" />
              </div>
              <button class="btn btn-primary">Publicar producto</button>
            </form>
          </div>
        </div>

        <!-- Plan -->
        <div id="planView" class="view" style="display:none;">
          <div class="card">
            <h5>Mi plan</h5>
            <p>Plan actual: <strong id="planActual">free</strong></p>
            <p>Actualizar a Premium para publicar m√°s productos y obtener beneficios.</p>
            <button class="btn btn-success" id="btnActualizarPlan">Actualizar a Premium</button>
          </div>
        </div>

      </section>
    </div>
  </main>

  <footer class="bg-light text-center py-3 mt-5">¬© 2025 TextilBog</footer>

  <script src="../bootstrap-5.3.3-dist/bootstrap-5.3.3-dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  // ---------------- utilidades ----------------
  const usuario = JSON.parse(localStorage.getItem("usuario"));
  if (!usuario) {
    alert("Debes iniciar sesi√≥n primero.");
    window.location.href = "iniciar-sesion.html";
  }

  // actualizar men√∫ (ocultar login)
  const linkLogin = document.getElementById("linkLogin");
  const linkCuenta = document.getElementById("linkCuenta");
  if (linkLogin) linkLogin.classList.add("d-none");
  if (linkCuenta) linkCuenta.classList.remove("d-none");

  // elementos
  const views = document.querySelectorAll(".view");
  const items = document.querySelectorAll(".sidebar .item");
  const perfilResumen = document.getElementById("perfilResumen");
  const ventasChartCtx = document.getElementById("ventasChart").getContext("2d");
  let ventasChart = null;

  // sidebar nav
  items.forEach(it => it.addEventListener("click", () => {
    items.forEach(i => i.classList.remove("active"));
    it.classList.add("active");
    const view = it.dataset.view;
    views.forEach(v => v.style.display = v.id === view ? "block" : "none");
    // cargar datos cuando se abra la vista
    if (view === "dashboardView") cargarEstadisticas();
    if (view === "productosView") cargarProductos();
  }));

  // mostrar resumen de perfil
  function renderPerfil() {
    perfilResumen.innerHTML = `
      <div><strong>${usuario.nombre}</strong></div>
      <div><small>${usuario.email}</small></div>
      <div style="margin-top:.6rem;"><small>Plan: <strong id="planBadge">${usuario.plan || 'free'}</strong></small></div>
    `;
    document.getElementById("planActual").textContent = usuario.plan || "free";
  }
  renderPerfil();

  // cerrar sesi√≥n
  document.getElementById("cerrarSesionBtn").addEventListener("click", () => {
    localStorage.removeItem("usuario");
    window.location.href = "iniciar-sesion.html";
  });

  // --------- Productos ----------
  async function cargarProductos() {
    try {
      const res = await fetch(`http://localhost:3000/api/productos/usuario/${usuario.id}`);
      const productos = await res.json();
      const lista = document.getElementById("listaProductos");
      lista.innerHTML = "";
      document.getElementById("productosActivos").textContent = productos.length;
      productos.forEach(p => {
        const card = document.createElement("div");
        card.className = "product-card card";
        card.innerHTML = `
          <img src="${p.imagen || '/uploads/placeholder.png'}" alt="${p.nombre}" />
          <div style="padding:0.6rem">
            <h6>${p.nombre}</h6>
            <p style="margin:0">$ ${Number(p.precio).toFixed(2)}</p>
            <p style="margin:0"><small>Stock: ${p.stock}</small></p>
            <div style="margin-top:0.6rem">
              <button class="btn btn-sm btn-warning me-1" data-id="${p.id}" data-action="editar">Editar</button>
              <button class="btn btn-sm btn-danger" data-id="${p.id}" data-action="eliminar">Eliminar</button>
            </div>
          </div>
        `;
        lista.appendChild(card);
      });

      // delegaci√≥n de eventos (editar/eliminar)
      lista.querySelectorAll("button").forEach(b => b.addEventListener("click", async (e) => {
        const id = e.target.dataset.id;
        const action = e.target.dataset.action;
        if (action === "eliminar") {
          if (!confirm("¬øEliminar este producto?")) return;
          await fetch(`http://localhost:3000/api/productos/${id}`, { method: "DELETE" });
          cargarProductos();
        } else if (action === "editar") {
          // simple prompt para editar nombre/precio/stock
          const nuevoNombre = prompt("Nombre", e.target.closest(".product-card").querySelector("h6").textContent);
          const nuevoPrecio = prompt("Precio", e.target.closest(".product-card").querySelector("p").textContent.replace("$","").trim());
          const nuevoStock = prompt("Stock", e.target.closest(".product-card").querySelector("small").textContent.replace("Stock:","").trim());
          const body = { nombre: nuevoNombre, precio: Number(nuevoPrecio), stock: Number(nuevoStock) };
          await fetch(`http://localhost:3000/api/productos/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
          cargarProductos();
        }
      }));
    } catch (err) {
      console.error(err);
      alert("No se pudieron cargar los productos.");
    }
  }

  // --------- Subir producto ----------
  document.getElementById("formSubir").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nombre = document.getElementById("p_nombre").value;
    const precio = parseFloat(document.getElementById("p_precio").value) || 0;
    const stock = parseInt(document.getElementById("p_stock").value) || 0;
    const descripcion = document.getElementById("p_descripcion").value;
    const inputImg = document.getElementById("p_imagen");

    let imagenBase64 = null;
    if (inputImg.files && inputImg.files[0]) {
      const file = inputImg.files[0];
      imagenBase64 = await fileToBase64(file);
    }

    try {
      const res = await fetch("http://localhost:3000/api/productos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          usuario_id: usuario.id,
          nombre,
          descripcion,
          precio,
          stock,
          imagenBase64
        })
      });
      const data = await res.json();
      if (res.ok) {
        alert("Producto publicado");
        e.target.reset();
        cargarProductos();
      } else {
        alert("Error publicando producto");
      }
    } catch (err) {
      console.error(err);
      alert("Error al publicar producto");
    }
  });

  function fileToBase64(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ------- Estad√≠sticas (Chart.js) -------
  async function cargarEstadisticas() {
  try {
    const res = await fetch(`http://localhost:3000/api/estadisticas/ventas/${usuario.id}`);
    const data = await res.json();

    if (!(ventasChart instanceof Chart)) {
      ventasChart = new Chart(ventasChartCtx, {
        type: 'bar',
        data: {
          labels: data.dias,
          datasets: [{
            label: 'Ventas semanales ($)',
            data: data.ventas,
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    } else {
      ventasChart.data.labels = data.dias;
      ventasChart.data.datasets[0].data = data.ventas;
      ventasChart.update();
    }

    const total = data.ventas.reduce((s,n)=>s+n,0);
    document.getElementById("totalVendido").textContent = `$${total.toFixed(2)}`;

  } catch (e) {
    console.error("Error en cargarEstadisticas", e);
  }
}


  // cargar datos iniciales (dashboard por defecto)
window.addEventListener("load", () => {
    // SOLO cargar los productos
    cargarProductos();

    // NO hacer click autom√°tico, solo mostrar dashboard
    cargarEstadisticas();
});


  // actualizar plan (simulado)
  document.getElementById("btnActualizarPlan").addEventListener("click", async () => {
    if (!confirm("Actualizar a Premium por $9.99? (simulado)")) return;
    // Llamada al backend que actualizar√≠a plan en usuarios (debes implementar endpoint PUT /api/usuarios/:id/plan)
    try {
      const res = await fetch(`http://localhost:3000/api/usuarios/${usuario.id}/plan`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ plan: "premium" })
      });
      if (res.ok) {
        alert("¬°Plan actualizado a Premium!");
        // actualizar localStorage
        usuario.plan = "premium";
        localStorage.setItem("usuario", JSON.stringify(usuario));
        renderPerfil();
      } else {
        alert("No se pudo actualizar el plan.");
      }
    } catch (err) {
      console.error(err);
      alert("Error actualizando plan.");
    }
  });
  </script>
</body>
</html>
